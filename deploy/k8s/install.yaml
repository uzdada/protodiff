---
# Namespace for ProtoDiff system
apiVersion: v1
kind: Namespace
metadata:
  name: protodiff-system
  labels:
    app.kubernetes.io/name: protodiff
    app.kubernetes.io/component: monitoring

---
# ServiceAccount for ProtoDiff
apiVersion: v1
kind: ServiceAccount
metadata:
  name: protodiff
  namespace: protodiff-system
  labels:
    app.kubernetes.io/name: protodiff

---
# ClusterRole with permissions to discover pods and read ConfigMaps
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: protodiff
  labels:
    app.kubernetes.io/name: protodiff
rules:
  - apiGroups: [""]
    resources: ["pods"]
    verbs: ["get", "list", "watch"]
  - apiGroups: [""]
    resources: ["configmaps"]
    verbs: ["get", "list", "watch"]

---
# ClusterRoleBinding to grant permissions
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: protodiff
  labels:
    app.kubernetes.io/name: protodiff
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: protodiff
subjects:
  - kind: ServiceAccount
    name: protodiff
    namespace: protodiff-system

---
# ConfigMap containing service-to-BSR module mappings
# IMPORTANT: Edit this section to map your gRPC services to BSR modules
apiVersion: v1
kind: ConfigMap
metadata:
  name: protodiff-mapping
  namespace: protodiff-system
  labels:
    app.kubernetes.io/name: protodiff
    app.kubernetes.io/component: config
data:
  # Map your service names to BSR modules
  # Format: service-name: "buf.build/org/MODULE_NAME"
  # "buf.build/proto-diff-bsr/test-services" is an example. (it's exist, but created for test)
  # Replace these examples with your actual services:
  grpc-server-go: "buf.build/proto-diff-bsr/test-services"
  grpc-server-java: "buf.build/proto-diff-bsr/test-services"

---
# Secret for BSR (Buf Schema Registry) authentication token
# IMPORTANT: For quickstart/testing, you can leave this empty and create the secret manually later
# For production, replace the empty token value with your actual BSR token from https://buf.build/settings/user
# SECURITY WARNING: Never commit actual tokens to Git. Use external secret management tools in production.
apiVersion: v1
kind: Secret
metadata:
  name: bsr-token
  namespace: protodiff-system
  labels:
    app.kubernetes.io/name: protodiff
    app.kubernetes.io/component: config
type: Opaque
stringData:
  token: ""  # Leave empty for quickstart. Create manually: kubectl create secret generic bsr-token --from-literal=token=YOUR_TOKEN -n protodiff-system

---
# Deployment for ProtoDiff
apiVersion: apps/v1
kind: Deployment
metadata:
  name: protodiff
  namespace: protodiff-system
  labels:
    app.kubernetes.io/name: protodiff
    app.kubernetes.io/component: monitor
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: protodiff
  template:
    metadata:
      labels:
        app.kubernetes.io/name: protodiff
    spec:
      serviceAccountName: protodiff
      containers:
        - name: protodiff
          image: wooojin2da/protodiff:latest
          imagePullPolicy: Always
          ports:
            - name: http
              containerPort: 8080
              protocol: TCP
          env:
            # Kubernetes configuration
            - name: CONFIGMAP_NAMESPACE
              value: "protodiff-system"
            - name: CONFIGMAP_NAME
              value: "protodiff-mapping"

            # BSR (Buf Schema Registry) configuration
            - name: BSR_TOKEN
              valueFrom:
                secretKeyRef:
                  name: bsr-token
                  key: token
            - name: USE_MOCK_BSR
              value: "false"  # Set to "true" for testing without BSR

            # Application configuration
            - name: DEFAULT_BSR_TEMPLATE
              value: "buf.build/acme/{service}"
            - name: WEB_ADDR
              value: ":8080"
            - name: SCAN_INTERVAL
              value: "30s"

            # Set HOME to /tmp for buf CLI cache
            - name: HOME
              value: "/tmp"
          livenessProbe:
            httpGet:
              path: /health
              port: http
            initialDelaySeconds: 10
            periodSeconds: 30
          readinessProbe:
            httpGet:
              path: /health
              port: http
            initialDelaySeconds: 5
            periodSeconds: 10
          resources:
            requests:
              cpu: 100m
              memory: 128Mi
            limits:
              cpu: 500m
              memory: 512Mi
          securityContext:
            runAsNonRoot: true
            runAsUser: 65532
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
            capabilities:
              drop:
                - ALL
          volumeMounts:
            - name: tmp
              mountPath: /tmp
      volumes:
        - name: tmp
          emptyDir: {}

---
# Service to expose ProtoDiff dashboard
apiVersion: v1
kind: Service
metadata:
  name: protodiff
  namespace: protodiff-system
  labels:
    app.kubernetes.io/name: protodiff
spec:
  type: ClusterIP
  ports:
    - port: 80
      targetPort: http
      protocol: TCP
      name: http
  selector:
    app.kubernetes.io/name: protodiff
